<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Value Plan — Project Reports</title>
  <meta name="description" content="Elegant interface to browse and copy Project Reports (connected to Google Sheets 'Project Reports' sheet)." />
  <!-- Use hosted Hive logo as favicon to avoid local 404 -->
  <link rel="icon" href="https://promote.hive.io/icons/hive-logo.png" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* BRAND / THEME VARIABLES */
    :root{
      --hive-black: #0c0c0c;
      --hive-light-gray: #e7e7f1;
      --hive-red: #e31337;
      --hive-red-hover: #c10c2c;
      --text-primary: #212529;
      --text-secondary: #6b7785;
      --maxw:1200px;
      --radius:12px;
      --shadow: 0 12px 40px rgba(2,6,23,0.12);
      --glass: rgba(255,255,255,0.6);
      --transition:240ms cubic-bezier(.2,.9,.2,1);
      --carousel-interval:4500;
      --carousel-speed:700;
    }
    /* LIGHT / DARK base */
    html.theme-light{ background: linear-gradient(180deg,#f6f8fa,#eef2f6); color:var(--text-primary); }
    html.theme-dark{ background: linear-gradient(180deg,#07121a,#04101a); color:var(--hive-light-gray); }
    html.theme-light { --card-bg:#ffffff; --muted:#6b7785; --modal-bg:#fff; --accent-text:var(--text-primary); --btn-ghost-border: rgba(0,0,0,0.06); --btn-ghost-text: var(--text-primary); }
    html.theme-dark { --card-bg:#07131a; --muted:#9fb0c8; --modal-bg:#07121a; --accent-text:var(--hive-light-gray); --btn-ghost-border: rgba(255,255,255,0.08); --btn-ghost-text: var(--hive-light-gray); }

    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; min-height:100vh;}
    .container{max-width:var(--maxw);margin:18px auto;padding:18px}

    /* Header */
    header.site-header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:14px;border-radius:12px;position:sticky;top:12px;z-index:60;background:var(--card-bg);box-shadow:var(--shadow)}
    .brand{display:flex;gap:12px;align-items:center}
    .brand img{width:56px;height:56px;border-radius:10px;object-fit:cover;border:2px solid rgba(0,0,0,0.04)}
    .brand h1{font-size:1.05rem;font-weight:800}
    .brand .sub{font-size:0.85rem;color:var(--text-secondary)}
    nav.main{display:flex;gap:12px;align-items:center}
    .nav-link{font-weight:600;padding:8px 10px;border-radius:8px;color:inherit;text-decoration:none}
    .controls{display:flex;gap:12px;align-items:center}
    .search{display:flex;align-items:center;gap:8px;background:var(--card-bg);padding:8px;border-radius:12px;border:1px solid rgba(0,0,0,0.04)}
    .search input{border:0;outline:none;background:transparent;font-size:0.95rem;width:260px;color:inherit}
    .select{padding:8px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:transparent;color:inherit}

    /* theme switch */
    .theme-toggle-btn{display:inline-flex;align-items:center;gap:10px;border-radius:999px;padding:8px 10px;border:0;background:transparent;cursor:pointer;font-weight:700;color:var(--accent-text)}
    .theme-icon{width:22px;height:22px;display:inline-flex;align-items:center;justify-content:center;flex:0 0 24px}

    /* CAROUSEL */
    .hero{margin-top:18px}
    .carousel{position:relative;border-radius:14px;background:var(--card-bg);box-shadow:var(--shadow);overflow:hidden}
    .carousel-track{display:flex;transition:transform var(--carousel-speed) cubic-bezier(.2,.9,.2,1);will-change:transform}
    .carousel-slide{min-width:100%;display:flex;align-items:flex-end;padding:22px;gap:18px;background-size:cover;background-position:center;position:relative;min-height:320px}
    .carousel-overlay{position:absolute;inset:0;background:linear-gradient(180deg, rgba(0,0,0,0.10), rgba(0,0,0,0.48));pointer-events:none}
    .carousel-content{position:relative;z-index:2;max-width:66%}
    .carousel-title{font-size:1.45rem;font-weight:900;margin-top:8px;color:var(--hive-light-gray);line-height:1.06}
    .carousel-actions{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
    .carousel-btn{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:800;display:inline-flex;align-items:center;gap:8px;text-decoration:none}
    .btn-primary{background:linear-gradient(90deg,var(--hive-red),var(--hive-red-hover));color:white}
    .btn-secondary{background:transparent;border:1px solid rgba(255,255,255,0.12);color:white}
    .carousel-nav{position:absolute;top:50%;transform:translateY(-50%);width:100%;display:flex;justify-content:space-between;pointer-events:none}
    .carousel-arrow{pointer-events:auto;background:rgba(0,0,0,0.36);border-radius:999px;padding:10px;margin:10px;cursor:pointer;border:0;color:white}

    /* Reports cards */
    .section{margin-top:18px}
    .section .header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
    .cards-grid{display:grid;grid-template-columns:repeat(1,1fr);gap:18px}
    @media(min-width:700px){ .cards-grid{grid-template-columns:repeat(2,1fr)} }
    @media(min-width:1000px){ .cards-grid{grid-template-columns:repeat(3,1fr)} }
    .card{border-radius:12px;background:var(--card-bg);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;transition:transform var(--transition)}
    .card:hover{transform:translateY(-8px)}
    .thumb{height:180px;object-fit:cover;width:100%;display:block}
    .card-body{padding:14px;display:flex;flex-direction:column;gap:8px;flex:1}
    .title{font-weight:800}
    .meta{font-size:0.9rem;color:var(--muted)}
    .budget{font-weight:700;color:var(--hive-red);}
    .card-actions{display:flex;gap:8px;margin-top:auto;flex-wrap:wrap}
    .btn{padding:10px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:700;display:inline-flex;align-items:center;gap:8px;text-decoration:none}
    .btn-ghost{background:transparent;border:1px solid var(--btn-ghost-border);color:var(--btn-ghost-text)}
    .btn-download{background:linear-gradient(90deg,var(--hive-red),var(--hive-red-hover));color:white}

    /* icons inside buttons */
    .btn .icon{width:16px;height:16px;display:inline-flex;align-items:center;justify-content:center;flex:0 0 16px}

    /* modal & overlays */
    .modal-back{position:fixed;inset:0;background:rgba(2,6,23,0.6);display:flex;justify-content:center;align-items:flex-start;padding:28px;z-index:9999;overflow:auto;opacity:0;transform:translateY(8px);transition:opacity 220ms,transform 220ms}
    .modal-back.show{opacity:1;transform:none}
    .modal{width:100%;max-width:980px;border-radius:12px;padding:20px;background:var(--modal-bg);color:inherit;box-shadow:0 20px 60px rgba(0,0,0,0.6)}
    .modal-grid{display:grid;gap:12px;grid-template-columns:repeat(1,1fr)}
    @media(min-width:640px){ .modal-grid{grid-template-columns:repeat(2,1fr)} }
    @media(min-width:980px){ .modal-grid{grid-template-columns:repeat(4,1fr)} }
    .mini-card{display:flex;flex-direction:column;gap:8px;border-radius:10px;padding:10px;background:var(--card-bg);cursor:pointer;align-items:center;text-align:center}
    .mini-card img{width:100%;height:90px;object-fit:cover;border-radius:8px}

    /* choice buttons */
    .choice{display:flex;gap:8px;justify-content:center;padding:12px}

    /* footer art: dark, modern, impactful */
    .fancy-footer{margin-top:18px;padding:28px;border-radius:14px;overflow:hidden;background:linear-gradient(180deg,#0b0b0b,#1b1b1b);position:relative;color:var(--hive-light-gray)}
    .fancy-footer .links{display:flex;flex-direction:column;gap:8px;align-items:flex-end}
    .fancy-footer .links a{display:block;font-weight:800;color:var(--hive-light-gray);text-decoration:none}
    .fancy-footer .brand-compact{display:flex;flex-direction:column;gap:6px}
    .fancy-footer .hive-mark{display:inline-flex;align-items:center;gap:8px}
    .fancy-footer .hive-mark svg{width:42px;height:42px}
    .fancy-footer .art-svg{position:absolute;right:-20px;bottom:-20px;opacity:0.14;width:420px;height:420px}

    html.theme-dark .fancy-footer{background:linear-gradient(180deg,#060606,#121212)}

    /* utilities */
    .muted{color:var(--muted)}
    .kicker{font-weight:800}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}

    /* MOBILE TWEAKS */
    @media (max-width:520px){ .search input{width:120px} .carousel-slide{min-height:240px;padding:14px} .carousel-content{max-width:100%} .carousel-title{font-size:1.1rem} .thumb{height:140px} .theme-toggle-btn{padding:6px 8px} .brand img{width:44px;height:44px} .fancy-footer .links{align-items:flex-start} }
  </style>
</head>
<body>
  <div class="container" role="main">

    <!-- SVG ICON SYMBOLS (for reuse) -->
    <svg style="position:absolute;width:0;height:0;overflow:hidden;" aria-hidden="true">
      <defs>
        <symbol id="icon-eye" viewBox="0 0 24 24">
          <path fill="currentColor" d="M12 5c-7 0-11 6.5-11 7s4 7 11 7 11-6.5 11-7-4-7-11-7zm0 11a4 4 0 110-8 4 4 0 010 8z" />
        </symbol>
        <symbol id="icon-download" viewBox="0 0 24 24">
          <path fill="currentColor" d="M12 3v10m0 0l-4-4m4 4l4-4M4 21h16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
        </symbol>
        <symbol id="icon-external" viewBox="0 0 24 24">
          <path fill="currentColor" d="M14 3h7v7m0-7L10 14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none" />
        </symbol>
        <symbol id="icon-close" viewBox="0 0 24 24"><path fill="currentColor" d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"/></symbol>
        <symbol id="icon-list" viewBox="0 0 24 24"><path fill="currentColor" d="M8 6h13M8 12h13M8 18h13M3 6h.01M3 12h.01M3 18h.01" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" fill="none"/></symbol>
      </defs>
    </svg>

    <!-- HEADER -->
    <header class="site-header" role="banner" aria-label="Header">
      <div class="brand">
        <!-- use official hive icon in header -->
        <img src="https://promote.hive.io/icons/hive-logo.png" alt="Hive logo">
        <div>
          <h1>Value Plan</h1>
          <div class="sub">Project Reports · Hive Magazine</div>
        </div>
      </div>

      <div class="controls" role="search" aria-label="Search and filters">
        <div class="search" title="Search reports">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="opacity:0.6"><path d="M21 21l-4.35-4.35M10.5 18A7.5 7.5 0 1010.5 3a7.5 7.5 0 000 15z"/></svg>
          <input id="searchInput" placeholder="Search reports by project, event or date" aria-label="Search reports">
        </div>

        <select id="projectFilter" class="select" aria-label="Filter by project">
          <option value="">All projects</option>
        </select>

        <button id="themeToggle" class="theme-toggle-btn" aria-label="Toggle theme" title="Toggle theme">
          <span class="theme-icon" id="themeIcon" aria-hidden="true">
            <svg id="icon-sun" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="display:none"><path d="M6.76 4.84L5 3.05 3.05 5 4.84 6.76l1.92-1.92zM1 13h3v-2H1v2zm10 9h2v-3h-2v3zm7.24-3.24l1.79 1.8 1.2-1.2-1.79-1.79-1.2 1.19zM17 13v-2h3v2h-3zM6.76 19.16l-1.8 1.79 1.2 1.2 1.79-1.79-1.19-1.2zM12 5a7 7 0 100 14 7 7 0 000-14z"/></svg>
            <svg id="icon-moon" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" style="display:none"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
          </span>
          <span id="themeLabel">Light</span>
        </button>
      </div>
    </header>

    <!-- CAROUSEL: last up to 5 reports -->
    <section class="hero" aria-label="Featured reports">
      <div class="carousel" id="carousel" aria-roledescription="carousel" tabindex="0">
        <div class="carousel-track" id="carouselTrack" aria-live="polite"></div>
        <div class="carousel-nav" aria-hidden="false">
          <button id="prev" class="carousel-arrow" aria-label="Previous slide">‹</button>
          <button id="next" class="carousel-arrow" aria-label="Next slide">›</button>
        </div>
      </div>
    </section>

    <!-- REPORTS -->
    <section class="section" aria-label="Reports">
      <div class="header">
        <div>
          <div class="kicker">Reports</div>
          <div class="muted">Available project reports — browse, read or make a copy</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="showMoreBtn" class="btn btn-ghost" style="display:none"><span class="icon"><svg width="16" height="16" viewBox="0 0 24 24"><use href="#icon-list"></use></svg></span>All reports</button>
        </div>
      </div>

      <div id="cardsGrid" class="cards-grid" aria-live="polite"></div>
    </section>

    <!-- FOOTER ART -->
    <footer class="fancy-footer" role="contentinfo" aria-label="Footer">
      <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;position:relative;z-index:2">
        <div class="brand-compact">
          <div style="font-weight:900;font-size:1.05rem" class="hive-mark">
            <!-- footer logo requested by you -->
            <img src="https://promote.hive.io/icons/hive-logo.png" alt="Hive logo" style="width:42px;height:42px;border-radius:6px;object-fit:cover" />
            <span>Value Plan</span>
          </div>
          <div class="muted" style="margin-top:6px">Curated project reports · Built on Hive</div>
        </div>

        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
          <div style="font-weight:800">Explore</div>
          <div class="links" style="margin-top:6px">
            <a href="https://hive.io" target="_blank" rel="noopener noreferrer">hive.io</a>
            <a href="https://valueplanreports.com" target="_blank" rel="noopener noreferrer">valueplanreports.com</a>
          </div>
        </div>
      </div>

      <!-- decorative svg: dark/gray art with red accent -->
      <svg class="art-svg" viewBox="0 0 600 600" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <defs>
          <linearGradient id="g1" x1="0" x2="1" y1="0" y2="1">
            <stop offset="0" stop-color="#444" stop-opacity="0.95"/>
            <stop offset="0.6" stop-color="#222" stop-opacity="0.9"/>
            <stop offset="1" stop-color="#000" stop-opacity="0.85"/>
          </linearGradient>
        </defs>
        <g transform="translate(0,0)" fill="url(#g1)">
          <path d="M420 420c60 0 120-40 160-80-40 40-100 80-160 80z" opacity="0.95"/>
          <path d="M480 300c30 10 70 10 90-20-20 40-60 30-90 20z" opacity="0.6"/>
        </g>
        <!-- subtle red accent ring -->
        <circle cx="340" cy="340" r="140" fill="none" stroke="var(--hive-red)" stroke-width="6" opacity="0.08" />
      </svg>
    </footer>

  </div>

  <!-- modal root -->
  <div id="modalRoot" aria-live="polite"></div>

  <script>
  (function(){
    'use strict';

    /* CONFIG */
    const SHEET_CSV = 'https://docs.google.com/spreadsheets/d/1tqPtEbS5EsajO-kgEgNtK1-eqXdZS8IOLaZ0CRKBrN4/export?format=csv&gid=1072006442';
    const COL = { project:0, event:1, date:2, image:3, hivepost:4, link:5, budget:6 };
    const CAROUSEL_MAX = 5;

    /* DOM refs */
    const carouselTrack = document.getElementById('carouselTrack');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');
    const cardsGrid = document.getElementById('cardsGrid');
    const projectFilter = document.getElementById('projectFilter');
    const searchInput = document.getElementById('searchInput');
    const themeToggle = document.getElementById('themeToggle');
    const themeLabel = document.getElementById('themeLabel');
    const iconSun = document.getElementById('icon-sun');
    const iconMoon = document.getElementById('icon-moon');
    const showMoreBtn = document.getElementById('showMoreBtn');
    const modalRoot = document.getElementById('modalRoot');

    /* utilities */
    function el(tag, attrs={}, children=[]){
      const node = document.createElement(tag);
      for (const k in attrs){
        if (k === 'class') node.className = attrs[k];
        else if (k === 'html') node.innerHTML = attrs[k];
        else node.setAttribute(k, attrs[k]);
      }
      (Array.isArray(children)?children:[children]).forEach(c => {
        if (c==null) return;
        if (typeof c === 'string') node.appendChild(document.createTextNode(c));
        else node.appendChild(c);
      });
      return node;
    }
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c] || c); }

    function splitCsvLine(line){
      const result = [];
      let cur='';
      let inQ=false;
      for (let i=0;i<line.length;i++){
        const ch = line[i];
        if (ch === '"'){
          inQ = !inQ;
          continue;
        }
        if (ch === ',' && !inQ){ result.push(cur); cur=''; continue; }
        cur += ch;
      }
      result.push(cur);
      return result.map(s => s.trim());
    }

    // Build a PeakD/reader link from the hivepost column (accepts full URL or @user/permlink or user/permlink)
    function buildPeakdUrl(hivepost){
      if (!hivepost) return null;
      const s = String(hivepost).trim();
      if (!s) return null;
      if (s.startsWith('http://') || s.startsWith('https://')) return s;
      // remove leading @ if present
      const cleaned = s.startsWith('@') ? s.slice(1) : s;
      // if it already looks like user/permlink, use it:
      if (/^[a-z0-9\-\_\.]+\/[a-z0-9\-\_\.]+$/i.test(cleaned)) return 'https://peakd.com/' + cleaned;
      // fallback
      return 'https://peakd.com/' + encodeURIComponent(cleaned);
    }

    // Restore makeCopyUrl so copy button works: handles Google Docs/Drive and /edit links
    function makeCopyUrl(url){
      if (!url) return url;
      try {
        const s = String(url).trim();
        // if it's a Google Docs editing link, convert to the "copy" flow
        if (s.includes('/edit')) {
          // Best effort: replace trailing /edit... with /copy
          return s.replace(/\/edit.*$/,'/copy');
        }
        // If it's a docs.google.com or drive.google.com share link, append a copy=true param
        if (s.includes('docs.google.com') || s.includes('drive.google.com')) {
          return s + (s.includes('?') ? '&' : '?') + 'copy=true';
        }
        // otherwise just return as-is
        return s;
      } catch(e){
        return url;
      }
    }

    // simple helper to create <svg><use href="#id"></use></svg>
    function iconNode(name){
      const svg = document.createElementNS('http://www.w3.org/2000/svg','svg');
      svg.setAttribute('width','16');
      svg.setAttribute('height','16');
      svg.setAttribute('viewBox','0 0 24 24');
      const use = document.createElementNS('http://www.w3.org/2000/svg','use');
      // set both href attributes for broad compatibility
      use.setAttributeNS('http://www.w3.org/1999/xlink','href','#' + name);
      use.setAttribute('href','#' + name);
      svg.appendChild(use);
      svg.classList.add('icon-svg');
      return svg;
    }

    /* state */
    let reports = [];
    let filtered = [];
    let carouselIndex = 0;
    let carouselAutoplay = null;

    /* render functions */
    function renderCarousel(entries){
      carouselTrack.innerHTML = '';
      if (!entries.length){
        const slide = el('div',{class:'carousel-slide', style:'background-image:url("https://picsum.photos/1400/600?random=22")'});
        slide.appendChild(el('div',{class:'carousel-overlay'}));
        const wrap = el('div',{class:'carousel-content'});
        wrap.appendChild(el('div',{class:'carousel-title'},['No featured reports available']));
        slide.appendChild(wrap);
        carouselTrack.appendChild(slide);
        return;
      }
      entries.forEach((r,i) => {
        const bg = r.image || ('https://picsum.photos/1400/600?random=' + (10+i));
        const slide = el('div',{class:'carousel-slide', style:'background-image:url("' + escapeHtml(bg) + '")'});
        slide.appendChild(el('div',{class:'carousel-overlay'}));
        const wrap = el('div',{class:'carousel-content'});
        wrap.appendChild(el('div',{class:'carousel-title'},[r.event || r.project || 'Untitled']));
        const actions = el('div',{class:'carousel-actions'});

        // View on PeakD - anchor that goes directly to the PeakD link from the sheet
        const viewHref = buildPeakdUrl(r.hivepost);
        const btnView = el('a',{
          class:'carousel-btn btn-primary',
          title: viewHref ? 'Open post on PeakD' : 'No PeakD link',
          target: '_blank',
          rel: 'noopener noreferrer',
          href: viewHref || '#'
        },[]);
        btnView.appendChild(iconNode('icon-eye'));
        btnView.appendChild(document.createTextNode('View Official Post on PeakD'));
        if (!viewHref) btnView.style.opacity = '0.6';

        // Copy action remains as before
        const btnCopy = el('button',{class:'carousel-btn btn-secondary', title:'Get a copy'},[]);
        btnCopy.appendChild(iconNode('icon-download'));
        btnCopy.appendChild(document.createTextNode('Get a Copy of the Report'));

        btnCopy.addEventListener('click', (e)=> { e.stopPropagation(); openReportWithChoice(r,'copy'); });

        actions.appendChild(btnView);
        actions.appendChild(btnCopy);
        wrap.appendChild(actions);
        slide.appendChild(wrap);
        carouselTrack.appendChild(slide);
      });
      carouselIndex = 0;
      updateCarouselTransform();
      startCarouselAuto();
    }

    function updateCarouselTransform(){
      carouselTrack.style.transform = 'translateX(-' + (carouselIndex * 100) + '%)';
    }

    function startCarouselAuto(){
      stopCarouselAuto();
      carouselAutoplay = setInterval(()=> {
        carouselIndex = (carouselIndex + 1) % Math.max(1, carouselTrack.children.length);
        updateCarouselTransform();
      }, Number(getComputedStyle(document.documentElement).getPropertyValue('--carousel-interval')) || 4500);
    }

    function stopCarouselAuto(){ if (carouselAutoplay) clearInterval(carouselAutoplay); carouselAutoplay = null; }

    function renderCards(list){
      cardsGrid.innerHTML = '';
      if (!list.length){ cardsGrid.appendChild(el('div',{class:'muted'},['No reports available.'])); showMoreBtn.style.display = 'none'; return; }
      list.forEach((r, idx) => {
        const card = el('article',{class:'card', tabindex:0});
        const thumb = r.image || ('https://picsum.photos/800/500?random=' + idx);
        const img = el('img',{class:'thumb', src: thumb, alt: r.event || r.project});
        const body = el('div',{class:'card-body'});
        body.appendChild(el('div',{class:'title'},[r.event || '(Untitled)']));
        const metaText = (r.project ? r.project + ' · ' : '') + (r.date || '');
        body.appendChild(el('div',{class:'meta muted'},[metaText]));
        if (r.budget) body.appendChild(el('div',{class:'budget'},['Budget: ' + r.budget]));
        const actions = el('div',{class:'card-actions'});

        // Copy button
        const btnCopy = el('button',{class:'btn btn-download', title:'Get a copy of the report (opens copy link)'},[]);
        btnCopy.appendChild(iconNode('icon-download'));
        btnCopy.appendChild(document.createTextNode('Get a Copy'));

        // View on PeakD - implemented as anchor that uses hivepost column
        const viewHref = buildPeakdUrl(r.hivepost);
        const btnHive = el('a',{
          class:'btn btn-ghost',
          title: viewHref ? 'Open on PeakD' : 'No PeakD link',
          target: '_blank',
          rel: 'noopener noreferrer',
          href: viewHref || '#'
        },[]);
        btnHive.appendChild(iconNode('icon-external'));
        btnHive.appendChild(document.createTextNode('View on PeakD'));
        if (!viewHref) btnHive.style.opacity = '0.6';

        btnCopy.addEventListener('click', (ev)=> { ev.stopPropagation(); handleCopyAction(r); });
        // anchor will handle opening the link, no extra handler needed

        actions.appendChild(btnCopy);
        actions.appendChild(btnHive);
        body.appendChild(actions);
        card.appendChild(img);
        card.appendChild(body);
        card.addEventListener('click', ()=> openReportWithChoice(r, null));
        card.addEventListener('keypress', (e)=> { if (e.key === 'Enter') openReportWithChoice(r, null); });
        cardsGrid.appendChild(card);
      });
      showMoreBtn.style.display = (reports.length > 10) ? 'inline-block' : 'none';
    }

    /* modals */
    function showModal(node){
      const backdrop = el('div',{class:'modal-back show', role:'dialog', 'aria-modal':'true'});
      const modal = el('div',{class:'modal'});
      modal.appendChild(node);
      backdrop.appendChild(modal);
      modalRoot.innerHTML = '';
      modalRoot.appendChild(backdrop);
      function close(){ modalRoot.innerHTML = ''; document.removeEventListener('keydown', onEsc); }
      function onEsc(e){ if (e.key === 'Escape') close(); }
      document.addEventListener('keydown', onEsc);
      backdrop.addEventListener('click', (e)=> { if (e.target === backdrop) close(); });
      return { close };
    }

    // open modal with choices; "View" is now an anchor pointing to PeakD (if available)
    async function openReportWithChoice(report, actionIfGiven){
      if (actionIfGiven === 'copy') return handleCopyAction(report);
      if (actionIfGiven === 'view') {
        const href = buildPeakdUrl(report.hivepost);
        if (href) window.open(href, '_blank', 'noopener');
        else alert('No PeakD/Hive link available in the sheet for this report.');
        return;
      }

      const wrap = el('div',{});
      wrap.appendChild(el('h3',{},[ report.event || 'Report' ]));
      wrap.appendChild(el('div',{class:'muted', style:'margin-bottom:12px'},[ (report.project ? report.project + ' · ' : '') + (report.date || '') ]));
      if (report.budget) wrap.appendChild(el('div',{class:'budget', style:'margin-bottom:8px'},['Budget: ' + report.budget]));
      const choice = el('div',{class:'choice'});

      const viewHref = buildPeakdUrl(report.hivepost);
      const btnView = el('a',{
        class:'btn btn-primary',
        title: viewHref ? 'Open on PeakD' : 'No PeakD link',
        target: '_blank',
        rel: 'noopener noreferrer',
        href: viewHref || '#'
      },[]);
      btnView.appendChild(iconNode('icon-eye'));
      btnView.appendChild(document.createTextNode('View Official Post on PeakD'));
      if (!viewHref) btnView.style.opacity = '0.6';

      const btnCopy = el('button',{class:'btn btn-download'},[]);
      btnCopy.appendChild(iconNode('icon-download'));
      btnCopy.appendChild(document.createTextNode('Get a Copy of the Report'));

      const btnCancel = el('button',{class:'btn btn-ghost'},[]);
      btnCancel.appendChild(iconNode('icon-close'));
      btnCancel.appendChild(document.createTextNode('Cancel'));

      choice.appendChild(btnView);
      choice.appendChild(btnCopy);
      choice.appendChild(btnCancel);
      wrap.appendChild(choice);
      const m = showModal(wrap);
      // focus the primary action
      btnView.focus();

      btnCopy.addEventListener('click', ()=> { m.close(); handleCopyAction(report); });
      btnCancel.addEventListener('click', ()=> { m.close(); });
    }

    function handleCopyAction(report){
      if (!report.link || !report.link.trim()){ alert('No link available to copy (column F is empty).'); return; }
      const copyUrl = makeCopyUrl(report.link);
      // open in a new tab; this should handle google docs copy flows and generic urls
      window.open(copyUrl, '_blank', 'noopener');
    }

    function openAllReportsModal(){
      const wrapper = el('div',{});
      wrapper.appendChild(el('h3',{},['All Reports']));
      wrapper.appendChild(el('div',{class:'muted', style:'margin-bottom:12px'},['Browse all available reports. Click a tile to choose an action.']));
      const grid = el('div',{class:'modal-grid'});
      reports.forEach(r => {
        const mc = el('div',{class:'mini-card'});
        const thumb = r.image || ('https://picsum.photos/320/180?random=' + Math.floor(Math.random()*1000));
        mc.appendChild(el('img',{src:thumb, alt:r.event || r.project}));
        mc.appendChild(el('div',{class:'muted'},[r.project || '']));
        mc.appendChild(el('div',{style:'font-weight:800'},[r.event || '(Untitled)']));
        mc.appendChild(el('div',{class:'muted'},[r.date || '']));
        if (r.budget) mc.appendChild(el('div',{class:'budget'},['Budget: ' + r.budget]));
        mc.addEventListener('click', ()=> { modalClose(); openReportWithChoice(r, null); });
        grid.appendChild(mc);
      });
      wrapper.appendChild(grid);
      const mRef = showModal(wrapper);
      const modalClose = () => mRef.close();
    }

    /* load CSV */
    async function loadSheet(){
      try {
        const res = await fetch(SHEET_CSV);
        if (!res.ok) throw new Error('Unable to fetch the Google Sheet CSV. Make sure the sheet is shared publicly (Anyone with the link can view).');
        const csv = await res.text();
        const lines = csv.split(/\r?\n/);
        let headerIndex = 0; while (headerIndex < lines.length && !lines[headerIndex].trim()) headerIndex++;
        const dataLines = lines.slice(headerIndex + 1).filter(Boolean);
        const parsed = [];
        for (const line of dataLines){ const cols = splitCsvLine(line); if (!cols.some(c => c.trim())) continue; parsed.push(cols); }
        reports = parsed.map((r, idx)=> ({ id: idx, project: r[COL.project] || '', event: r[COL.event] || '', date: r[COL.date] || '', image: r[COL.image] || '', hivepost: r[COL.hivepost] || '', link: r[COL.link] || '', budget: r[COL.budget] || '' })).filter(x => (x.project || x.event));
        const projects = [...new Set(reports.map(r=> r.project).filter(Boolean))].sort((a,b)=> a.localeCompare(b));
        projectFilter.innerHTML = '<option value="">All projects</option>' + projects.map(p=> '<option value="' + escapeHtml(p) + '">' + escapeHtml(p) + '</option>').join('');
        const latest = reports.slice().reverse().filter(Boolean).slice(0, CAROUSEL_MAX);
        renderCarousel(latest);
        filtered = reports.slice();
        renderCards(filtered);
        showMoreBtn.style.display = (reports.length > 10) ? 'inline-block' : 'none';
      } catch(e){
        carouselTrack.innerHTML = '';
        carouselTrack.appendChild(el('div',{class:'carousel-slide'},[ el('div',{class:'carousel-overlay'}), el('div',{class:'carousel-content'}, [ el('div',{class:'carousel-title'},['Unable to load reports']) ]) ]));
        cardsGrid.innerHTML = '<div class="muted">Error loading the sheet: ' + escapeHtml(String(e.message || e)) + '</div>';
        console.error(e);
      }
    }

    /* events */
    prevBtn.addEventListener('click', ()=> { stopCarouselAuto(); carouselIndex = (carouselIndex - 1 + Math.max(1, carouselTrack.children.length)) % Math.max(1, carouselTrack.children.length); updateCarouselTransform(); startCarouselAuto(); });
    nextBtn.addEventListener('click', ()=> { stopCarouselAuto(); carouselIndex = (carouselIndex + 1) % Math.max(1, carouselTrack.children.length); updateCarouselTransform(); startCarouselAuto(); });
    carouselTrack.addEventListener('mouseenter', ()=> stopCarouselAuto());
    carouselTrack.addEventListener('mouseleave', ()=> startCarouselAuto());
    window.addEventListener('resize', ()=> setTimeout(updateCarouselTransform, 80));

    projectFilter.addEventListener('change', ()=> {
      const p = projectFilter.value;
      const q = (searchInput.value || '').toLowerCase().trim();
      filtered = reports.filter(r => {
        if (p && r.project !== p) return false;
        if (!q) return true;
        return (r.event + ' ' + r.project + ' ' + r.date).toLowerCase().includes(q);
      });
      renderCards(filtered);
    });

    searchInput.addEventListener('input', ()=> projectFilter.dispatchEvent(new Event('change')));
    showMoreBtn.addEventListener('click', openAllReportsModal);

    function initTheme(){
      const root = document.documentElement;
      const saved = localStorage.getItem('vp_theme') || 'light';
      root.classList.remove('theme-light','theme-dark');
      root.classList.add(saved === 'light' ? 'theme-light' : 'theme-dark');
      const isLight = saved === 'light';
      themeLabel.textContent = isLight ? 'Light' : 'Dark';
      iconSun.style.display = isLight ? 'inline' : 'none';
      iconMoon.style.display = isLight ? 'none' : 'inline';
    }

    themeToggle.addEventListener('click', ()=> {
      const root = document.documentElement;
      const cur = root.classList.contains('theme-light') ? 'light' : 'dark';
      const next = cur === 'light' ? 'dark' : 'light';
      root.classList.remove('theme-light','theme-dark');
      root.classList.add(next === 'light' ? 'theme-light' : 'theme-dark');
      localStorage.setItem('vp_theme', next);
      themeLabel.textContent = next === 'light' ? 'Light' : 'Dark';
      iconSun.style.display = next === 'light' ? 'inline' : 'none';
      iconMoon.style.display = next === 'light' ? 'none' : 'inline';
    });

    // keyboard nav for carousel
    document.getElementById('carousel').addEventListener('keydown', function(e){ if (e.key === 'ArrowLeft') prevBtn.click(); if (e.key === 'ArrowRight') nextBtn.click(); });

    /* boot */
    (async function boot(){ initTheme(); await loadSheet(); })();
    // expose refresh
    window.ProjectReports = { refresh: loadSheet };
  })();
  </script>
</body>
</html>
