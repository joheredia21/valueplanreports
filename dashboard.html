<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hive — Project Spend Dashboard (Audited v2, EventType fix)</title>
  <link rel="icon" type="image/png" href="https://promote.hive.io/icons/hive-logo.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>

  <style>
    :root{
      --hive-black: #212529;
      --hive-red: #e31337;
      --hive-red-hover: #c10c2c;
      --text-primary: #0f1720;
      --text-secondary: rgba(15,23,32,0.65);
      --muted-2: rgba(15,23,32,0.45);
      --bg-light: #f6f7f9;
      --panel: #ffffff;
      --card-bg: rgba(0,0,0,0.02);
      --shadow: 0 12px 40px rgba(16,24,32,0.06);
      --radius: 12px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }

    html[data-theme='light'] { background: var(--bg-light); color: var(--text-primary); }
    html[data-theme='light'] .panel, html[data-theme='light'] .card { background: var(--panel); color: var(--text-primary); }

    html[data-theme='dark']  { background: linear-gradient(180deg,#050607,#030304); color: #f4f6f8; }
    html[data-theme='dark'] .panel, html[data-theme='dark'] .card {
      background: rgba(20,20,22,0.66);
      color: #eef2f6;
      border: 1px solid rgba(255,255,255,0.06);
      box-shadow: 0 12px 40px rgba(0,0,0,0.65);
    }
    html[data-theme='dark'] .muted { color: rgba(255,255,255,0.64); }
    html[data-theme='dark'] .metric-title { color: rgba(255,255,255,0.60); }
    html[data-theme='dark'] .metric-value { color: rgba(255,255,255,0.95); }

    body { margin:0; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    .container { max-width:1220px; margin:20px auto; padding:18px; }

    .topbar { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px; }
    .logo { width:56px; height:56px; object-fit:contain; border-radius:8px; }
    .title h1 { margin:0; font-size:1.05rem; font-weight:700; color:inherit; }
    .title p { margin:0; color:var(--text-secondary); font-size:0.92rem; }

    .nav-menu { display:flex; gap:10px; align-items:center; }
    .nav-link { text-decoration:none; padding:8px 12px; border-radius:8px; font-weight:600; color:inherit; }
    .switch { width:46px; height:26px; border-radius:20px; padding:3px; display:flex; align-items:center; cursor:pointer; background:rgba(0,0,0,0.06); border:0; }
    .knob { width:20px; height:20px; border-radius:50%; background:#fff; transition: transform .22s ease; box-shadow:0 4px 12px rgba(0,0,0,0.08); }

    .metrics { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap:16px; margin:16px 0; }
    .card { border-radius:var(--radius); padding:14px; box-shadow:var(--shadow); background:var(--panel); border:1px solid rgba(15,23,32,0.04); opacity:0; transform:translateY(8px); transition: all .42s ease; }
    .card.revealed { opacity:1; transform:none; }
    .metric-title { font-size:0.85rem; color:var(--muted-2); }
    .metric-value { margin-top:8px; font-size:1.6rem; font-weight:800; color:inherit; opacity:0.95; }

    .grid { display:grid; grid-template-columns: 1fr 420px; gap:18px; }
    @media (max-width:1000px){ .grid { grid-template-columns: 1fr; } }

    .panel { border-radius:12px; padding:12px; background:var(--panel); border:1px solid rgba(15,23,32,0.04); box-shadow:var(--shadow); opacity:0; transform:translateY(10px); transition:all .42s ease; }
    .panel.revealed { opacity:1; transform:none; }
    .panel-header { display:flex; justify-content:space-between; gap:8px; align-items:center; margin-bottom:8px; }
    .panel-header h3 { margin:0; font-size:1rem; color:inherit; }
    .muted { color:var(--text-secondary); }

    .filters { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:6px; }
    .filters input, .filters select { padding:8px 10px; border-radius:8px; border:1px solid rgba(15,23,32,0.06); background:transparent; color:inherit; min-width:120px; }
    .filters button { background:var(--hive-red); color:#fff; padding:8px 10px; border-radius:8px; border:0; cursor:pointer; }

    html[data-theme='dark'] .filters input, html[data-theme='dark'] .filters select {
      color: #000 !important;
      background: rgba(255,255,255,0.95) !important;
      border: 1px solid rgba(0,0,0,0.06);
    }

    .chart-wrap { position:relative; width:100%; border-radius:10px; overflow:hidden; background:transparent; }
    .chart-wrap.large { height:460px; }
    .chart-wrap.medium { height:360px; }
    .chart-wrap.small { height:300px; }
    .chart-empty { position:absolute; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.02); color:var(--text-secondary); font-weight:600; font-size:14px; z-index:5; }

    #mapchart { height:420px; border-radius:10px; overflow:hidden; background:#dff0ff; }
    .table-wrap { overflow:auto; max-height:360px; border-radius:10px; }
    table { width:100%; border-collapse:collapse; font-size:0.92rem; }
    thead th { position:sticky; top:0; text-align:left; padding:8px; font-weight:700; color:var(--text-secondary); background:transparent; }
    tbody td { padding:8px; border-bottom:1px solid rgba(15,23,32,0.04); }

    footer { text-align:center; margin-top:26px; color:var(--text-secondary); }

    @media (max-width:640px){
      .nav-menu { display:none; }
      .logo { width:48px; height:48px; }
      .chart-wrap.large { height:320px; }
      .chart-wrap.medium { height:260px; }
      .chart-wrap.small { height:200px; }
    }
  </style>
</head>
<body>
  <div class="container" role="application">
    <header class="topbar" aria-label="Main header">
      <div style="display:flex; gap:14px; align-items:center;">
        <img src="https://files.peakd.com/file/peakd-hive/joheredia21/23uQtuwkDLZfCzn6YTdXZFTf64Xe3xMLBUMFT3LTNicRjk43MCUWgsUGaXfS59WFPbHZu.png" alt="Hive logo" class="logo" id="main-logo">
        <div class="title">
          <h1>Hive — Project Spend Dashboard</h1>
          <p class="muted">Interactive reporting — source: public Google Sheet</p>
        </div>
      </div>

      <div style="display:flex; gap:14px; align-items:center;">
        <nav id="main-nav" class="nav-menu" role="menubar" aria-hidden="false">
          <a href="index.html#dashboard" class="nav-link" role="menuitem">Dashboard</a>
          <a href="https://promote.hive.io" class="nav-link" role="menuitem">Metrics</a>
          <a href="index.html#posts" class="nav-link" role="menuitem">Posts</a>
          <a href="reports.html" class="nav-link" role="menuitem">Reports</a>
          <a href="calendar.html" class="nav-link" role="menuitem">Calendar</a>
          <a href="https://hive.io" target="_blank" rel="noopener noreferrer" class="nav-link" role="menuitem">Hive.io</a>
        </nav>

        <div class="theme-switch" title="Toggle light/dark mode">
          <div id="theme-toggle" class="switch" role="switch" aria-checked="true" tabindex="0">
            <div class="knob" id="switch-knob"></div>
          </div>
        </div>
      </div>
    </header>

    <section class="metrics" id="top-metrics" aria-live="polite">
      <div class="card"><div class="metric-title">Total HBD</div><div class="metric-value"><span id="total-hbd">—</span></div></div>
      <div class="card"><div class="metric-title">Total Hive</div><div class="metric-value"><span id="total-hive">—</span></div></div>
      <div class="card"><div class="metric-title">Total (Hive → HBD)</div><div class="metric-value"><span id="total-hive-to-hbd">—</span></div></div>
      <div class="card"><div class="metric-title">Total Spend (HBD)</div><div class="metric-value"><span id="total-spend">—</span></div></div>
    </section>

    <div class="panel" id="filters-panel" role="region" aria-label="Filters">
      <div class="panel-header">
        <h3>Filters</h3>
        <p class="muted">Filter by date, country, category, theme or wallet</p>
      </div>
      <div class="filters" aria-hidden="false">
        <input type="date" id="date-from" aria-label="Date from">
        <input type="date" id="date-to" aria-label="Date to">
        <select id="filter-country" aria-label="Country"><option value="">All countries</option></select>
        <select id="filter-category" aria-label="Category"><option value="">All categories</option></select>
        <select id="filter-theme" aria-label="Theme"><option value="">All themes</option></select>
        <!-- Hidden control for Event Type filtering (used programmatically by charts) -->
        <select id="filter-eventtype" aria-label="Event Type" style="display:none"><option value="">All event types</option></select>

        <input type="search" id="search-wallet" placeholder="Search wallet..." aria-label="Search wallet">
        <button id="reset-filters">Reset</button>
      </div>
    </div>

    <div class="grid" style="margin-top:14px;">
      <main>
        <section class="panel" id="panel-overview">
          <div class="panel-header">
            <h3>Overview — Cumulative Spend</h3>
            <p class="muted">Cumulative total spend over time (calculated from column "Total Spend")</p>
          </div>

          <div class="chart-wrap large">
            <div id="chart-cumulative-empty" class="chart-empty" style="display:none">No data for cumulative chart — check sheet/public access or column headers</div>
            <canvas id="chart-cumulative" aria-label="Cumulative spend chart"></canvas>
          </div>

          <div style="height:14px"></div>
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
            <div class="chart-wrap medium"><canvas id="chart-category" aria-label="Category distribution"></canvas></div>
            <div class="chart-wrap medium"><canvas id="chart-eventtype" aria-label="Event Type distribution"></canvas></div>
          </div>
        </section>

        <section class="panel" style="margin-top:14px;">
          <div class="panel-header">
            <h3>Top projects & Top wallets</h3>
            <p class="muted">Top funded projects and wallets (by Total Spend)</p>
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
            <div class="chart-wrap medium"><canvas id="chart-top-projects" aria-label="Top projects"></canvas></div>
            <div class="chart-wrap medium"><canvas id="chart-top-wallets" aria-label="Top wallets"></canvas></div>
          </div>
        </section>
      </main>

      <aside class="right-col">
        <section class="panel" id="panel-map">
          <div class="panel-header">
            <h3>Map — Spend by country</h3>
            <p class="muted">Click a country to filter results</p>
          </div>
          <div id="mapchart" aria-label="World map"></div>
          <div id="map-info" class="muted" style="padding:8px; display:none;"></div>
        </section>

        <section class="panel" id="panel-table" style="margin-top:14px;">
          <div class="panel-header">
            <h3>Data table</h3>
            <p class="muted">Click a row to filter by wallet</p>
          </div>
          <div class="table-wrap" id="table-wrap">
            <table id="data-table" aria-describedby="table-desc">
              <thead>
                <tr>
                  <th>Wallet</th><th>Date</th><th>HBD</th><th>Hive</th><th>Event/Project</th><th>Country</th><th>Theme</th><th>Event Type</th><th>Category</th><th>Hive→HBD</th><th>Total Spend</th><th>Cumulative (sheet)</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div id="table-desc" class="muted" style="padding:8px;">Rows update when you apply filters</div>
          </div>
        </section>
      </aside>
    </div>

    <footer><div style="padding-top:18px;" class="muted">Designed for Hive • Data from public Google Sheets</div></footer>
  </div>

  <script>
  (function(){
    'use strict';

    // CONFIG
    const SHEET_ID = '1tqPtEbS5EsajO-kgEgNtK1-eqXdZS8IOLaZ0CRKBrN4';
    const GID = '1417340119';
    const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${GID}&tqx=out:json`;
    const GEOJSON_URL = 'https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json';

    let records = [];
    let charts = {};
    let map = null;
    let geoLayer = null;
    let currentCountryAgg = {};

    const COUNTRY_ALIAS = {
      'usa': 'united states of america',
      'us': 'united states of america',
      'united states': 'united states of america',
      'uk': 'united kingdom',
      'great britain': 'united kingdom',
      'venezuela': 'venezuela',
      'russia': 'russian federation',
      'bolivia': 'bolivia (plurinational state of)',
      'iran': 'iran (islamic republic of)',
      'south korea': 'korea, republic of',
      'north korea': "korea, democratic people's republic of",
    };

    function log(...a){ try{ console.debug('[DASH]', ...a); }catch(e){} }

    function parseNumberFlexible(v){
      if(v === null || v === undefined) return 0;
      if(typeof v === 'number') return v;
      let s = String(v).trim();
      if(!s) return 0;
      s = s.replace(/\u00A0/g,'').replace(/[^0-9\.,-]/g,'').trim();
      const lastDot = s.lastIndexOf('.');
      const lastComma = s.lastIndexOf(',');
      if(lastDot>-1 && lastComma>-1){
        if(lastDot>lastComma) s = s.replace(/,/g,'');
        else s = s.replace(/\./g,'').replace(/,/g,'.');
      } else if(lastComma>-1 && lastDot===-1){
        s = s.replace(/,/g,'.');
      }
      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
    }

    function parseDateFlexible(d){
      if(!d) return null;
      if(typeof d === 'object' && d instanceof Date) return d;
      if(typeof d === 'number') return new Date(Math.round((d - 25569) * 86400 * 1000));
      let s = String(d).trim();
      s = s.replace(/\u00A0/g,'').replace(/\./g,'/').replace(/-/g,'/').replace(/\s+/g,' ');
      const direct = new Date(s);
      if(!isNaN(direct)) return direct;
      const parts = s.split('/');
      if(parts.length===3){
        let [a,b,c] = parts.map(p => p.trim());
        if(c && c.length===4){
          const tryDayFirst = new Date(`${c}-${b.padStart(2,'0')}-${a.padStart(2,'0')}`);
          if(!isNaN(tryDayFirst)) return tryDayFirst;
          const tryMonthFirst = new Date(`${c}-${a.padStart(2,'0')}-${b.padStart(2,'0')}`);
          if(!isNaN(tryMonthFirst)) return tryMonthFirst;
        }
      }
      const fallback = new Date(s);
      return isNaN(fallback) ? null : fallback;
    }

    function normalizeName(s){
      if(!s) return '';
      return String(s).toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^\w\s]/g,'').replace(/\s+/g,' ').trim();
    }

    function fmt(n){ return (Number(n)||0).toLocaleString(undefined,{ maximumFractionDigits:2 }); }
    function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g,m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    async function fetchSheet(){
      log('Fetching', GVIZ_URL);
      const res = await fetch(GVIZ_URL);
      if(!res.ok) throw new Error('Failed to fetch sheet: ' + res.status);
      const txt = await res.text();
      const firstBrace = txt.indexOf('{'), lastBrace = txt.lastIndexOf('}');
      if(firstBrace === -1 || lastBrace === -1) throw new Error('Unexpected GViz format');
      const jsonText = txt.substring(firstBrace, lastBrace+1);
      const data = JSON.parse(jsonText);
      const cols = data.table.cols.map(c => (c && c.label) ? String(c.label).trim() : (c && c.id) ? String(c.id).trim() : '');
      const rows = data.table.rows.map(r => r.c.map(cell => {
        if(!cell) return '';
        if(cell.f !== undefined && cell.f !== null && String(cell.f).trim() !== '') return cell.f;
        if(cell.v !== undefined && cell.v !== null) return cell.v;
        return '';
      }));
      log('Cols', cols);
      log('Rows', rows.length);
      return { cols, rows };
    }

    function processRows(cols, rows){
      const colNormalized = cols.map(c => (c||'').toString().toLowerCase().trim());

      let cumulIndex = -1;
      for(let i=0;i<colNormalized.length;i++){
        if(colNormalized[i] === 'cumulative spending') { cumulIndex = i; break; }
      }
      if(cumulIndex === -1){
        for(let i=0;i<colNormalized.length;i++){
          if(colNormalized[i].includes('cumul') || colNormalized[i].includes('cumulative')) { cumulIndex = i; break; }
        }
      }

      let dateIndex = colNormalized.findIndex(h => h === 'date' || h === 'fecha' || h.includes('date'));
      if(dateIndex === -1) dateIndex = colNormalized.findIndex(h => h.includes('fecha'));

      log('Detected indices: date=', dateIndex, 'cumul=', cumulIndex);

      const out = [];
      for(const r of rows){
        const recObj = {};
        for(let i=0;i<cols.length;i++) recObj[(cols[i]||`col${i}`)] = (r[i] !== undefined && r[i] !== null) ? r[i] : '';
        const getByKey = (name) => {
          const key = Object.keys(recObj).find(k => k.replace(/\s+/g,'').toLowerCase() === name.replace(/\s+/g,'').toLowerCase());
          return key ? recObj[key] : '';
        };
        const Wallet = getByKey('Wallet') || '';
        const DateRaw = (dateIndex !== -1) ? r[dateIndex] : (getByKey('Date') || '');
        const DateObj = parseDateFlexible(DateRaw);
        const HBD = parseNumberFlexible(getByKey('HBD') || '');
        const Hive = parseNumberFlexible(getByKey('Hive') || '');
        const EventProject = getByKey('Event/Project') || getByKey('Event') || '';
        const CountryRaw = (getByKey('Country')||'').toString().trim();
        const CountryNorm = normalizeName(CountryRaw);
        const CountryMapped = COUNTRY_ALIAS[CountryNorm] ? COUNTRY_ALIAS[CountryNorm] : CountryRaw;
        const Country = (CountryMapped||'').toString().trim();
        const Theme = (getByKey('Theme')||'').toString().trim();
        const EventType = (getByKey('Event Type')||getByKey('EventType')||'').toString().trim();
        const Category = (getByKey('Category')||'').toString().trim();
        const HiveToHBD = parseNumberFlexible(getByKey('Hive To HBD') || getByKey('HiveToHBD') || '');
        const TotalSpend = parseNumberFlexible(getByKey('Total Spend') || getByKey('TotalSpend') || '');

        let CumulativeSpend = null;
        if(cumulIndex !== -1){
          const raw = r[cumulIndex];
          if(raw !== undefined && raw !== null && String(raw).trim() !== '') CumulativeSpend = parseNumberFlexible(raw);
        } else {
          const altKey = Object.keys(recObj).find(k => k.toLowerCase().includes('cumul') || k.toLowerCase().includes('cumulative'));
          if(altKey){
            const raw = recObj[altKey];
            if(raw !== undefined && raw !== null && String(raw).trim() !== '') CumulativeSpend = parseNumberFlexible(raw);
          }
        }

        out.push({ Wallet, DateObj, HBD, Hive, EventProject, Country, Theme, EventType, Category, HiveToHBD, TotalSpend, CumulativeSpend });
      }

      log('Processed', out.length, 'records sample:', out.slice(0,6).map(r=>({d: r.DateObj ? r.DateObj.toISOString().slice(0,10) : null, total: r.TotalSpend, cumul: r.CumulativeSpend})));
      return out.filter(r => r.Wallet || r.DateObj || r.HBD || r.Hive || r.TotalSpend || r.CumulativeSpend !== null);
    }

    function populateFilters(recs){
      const countrySet = Array.from(new Set(recs.map(r => r.Country).filter(Boolean))).sort();
      const selCountry = document.getElementById('filter-country'); selCountry.innerHTML = '<option value="">All countries</option>';
      countrySet.forEach(c => { const o=document.createElement('option'); o.value=c; o.textContent=c; selCountry.appendChild(o); });

      const catSet = Array.from(new Set(recs.map(r => r.Category).filter(Boolean))).sort();
      const selCat = document.getElementById('filter-category'); selCat.innerHTML = '<option value="">All categories</option>';
      catSet.forEach(c => { const o=document.createElement('option'); o.value=c; o.textContent=c; selCat.appendChild(o); });

      const themeSet = Array.from(new Set(recs.map(r => r.Theme).filter(Boolean))).sort();
      const selTheme = document.getElementById('filter-theme'); selTheme.innerHTML = '<option value="">All themes</option>';
      themeSet.forEach(t => { const o=document.createElement('option'); o.value=t; o.textContent=t; selTheme.appendChild(o); });

      // populate eventtype hidden select so the chart legend can set it (integrates with existing filter flow)
      const etSet = Array.from(new Set(recs.map(r => r.EventType).filter(Boolean))).sort();
      const selET = document.getElementById('filter-eventtype'); selET.innerHTML = '<option value="">All event types</option>';
      etSet.forEach(e => { const o=document.createElement('option'); o.value=e; o.textContent=e; selET.appendChild(o); });
    }

    function renderTopMetrics(recs){
      document.getElementById('total-hbd').textContent = fmt(recs.reduce((s,r)=> s + (r.HBD||0), 0));
      document.getElementById('total-hive').textContent = fmt(recs.reduce((s,r)=> s + (r.Hive||0), 0));
      document.getElementById('total-hive-to-hbd').textContent = fmt(recs.reduce((s,r)=> s + (r.HiveToHBD||0), 0));
      document.getElementById('total-spend').textContent = fmt(recs.reduce((s,r)=> s + (r.TotalSpend||0), 0));
    }

    function renderTable(recs){
      const tbody = document.querySelector('#data-table tbody'); tbody.innerHTML = '';
      const sorted = recs.slice().sort((a,b)=>{
        if(!a.DateObj && !b.DateObj) return 0;
        if(!a.DateObj) return 1;
        if(!b.DateObj) return -1;
        return b.DateObj - a.DateObj;
      });
      for(const r of sorted){
        const tr = document.createElement('tr');
        tr.innerHTML = '<td>' + escapeHtml(r.Wallet) + '</td>'
          + '<td>' + (r.DateObj ? r.DateObj.toISOString().slice(0,10) : '') + '</td>'
          + '<td>' + (r.HBD ? fmt(r.HBD) : '') + '</td>'
          + '<td>' + (r.Hive ? fmt(r.Hive) : '') + '</td>'
          + '<td>' + escapeHtml(r.EventProject) + '</td>'
          + '<td>' + escapeHtml(r.Country) + '</td>'
          + '<td>' + escapeHtml(r.Theme) + '</td>'
          + '<td>' + escapeHtml(r.EventType) + '</td>'
          + '<td>' + escapeHtml(r.Category) + '</td>'
          + '<td>' + (r.HiveToHBD ? fmt(r.HiveToHBD) : '') + '</td>'
          + '<td>' + (r.TotalSpend ? fmt(r.TotalSpend) : '') + '</td>'
          + '<td>' + (r.CumulativeSpend !== null && r.CumulativeSpend !== undefined ? fmt(r.CumulativeSpend) : '') + '</td>';
        tr.addEventListener('click', ()=>{ document.getElementById('search-wallet').value = r.Wallet || ''; applyFiltersDebounced(); window.scrollTo({top:0,behavior:'smooth'}); });
        tbody.appendChild(tr);
      }
    }

    function createOrUpdateChart(id, config){
      if(charts[id]){ try{ charts[id].destroy(); } catch(e){} charts[id] = null; }
      const ctxEl = document.getElementById(id); if(!ctxEl) return;
      if(!config.options) config.options = {};
      config.options.responsive = true; config.options.maintainAspectRatio = false;
      const tickColor = (document.documentElement.getAttribute('data-theme') === 'dark') ? 'rgba(255,255,255,0.72)' : (getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') || '#666');
      if(config.options.scales){
        Object.keys(config.options.scales).forEach(k => {
          if(!config.options.scales[k].ticks) config.options.scales[k].ticks = {};
          config.options.scales[k].ticks.color = config.options.scales[k].ticks.color || tickColor;
        });
      }
      const ctx = ctxEl.getContext('2d');
      charts[id] = new Chart(ctx, config);
      try{ charts[id].update(); }catch(e){}
    }

    function generatePalette(n){
      const base = '#e31337';
      const arr = [];
      for(let i=0;i<n;i++){
        arr.push(shadeColor(base, 6 + (i*(40/Math.max(1,n)))));
      }
      return arr;
    }
    function shadeColor(hex, percent){
      hex = hex.replace('#','');
      if(hex.length===3) hex = hex.split('').map(h=>h+h).join('');
      const r = parseInt(hex.substring(0,2),16), g = parseInt(hex.substring(2,4),16), b = parseInt(hex.substring(4,6),16);
      const amt = Math.round(2.55 * percent);
      const R = Math.min(255, Math.max(0, r + amt)), G = Math.min(255, Math.max(0, g + amt)), B = Math.min(255, Math.max(0, b + amt));
      return `rgb(${R},${G},${B})`;
    }

    function buildCumulativeSeries(recs){
      const hasTotal = recs.some(r => r.TotalSpend !== undefined && r.TotalSpend !== null && Number(r.TotalSpend) !== 0);
      if(hasTotal){
        const dayMap = new Map();
        const withDates = recs.filter(r => r.DateObj && (r.TotalSpend !== null && r.TotalSpend !== undefined));
        for(const r of withDates){
          const iso = r.DateObj.toISOString().slice(0,10);
          dayMap.set(iso, (dayMap.get(iso) || 0) + Number(r.TotalSpend || 0));
        }
        const entries = Array.from(dayMap.entries()).sort((a,b)=> a[0].localeCompare(b[0]));
        const labels = []; const values = [];
        let cum = 0;
        for(const [d, amount] of entries){ cum += Number(amount || 0); labels.push(d); values.push(Math.round(cum*100)/100); }
        return { labels, values, source: 'calc' };
      } else {
        const withCumul = recs.filter(r => r.DateObj && (r.CumulativeSpend !== null && r.CumulativeSpend !== undefined && r.CumulativeSpend !== ''));
        if(withCumul.length === 0) return { labels: [], values: [], source: 'none' };
        const map = new Map();
        for(const r of withCumul){
          const iso = r.DateObj.toISOString().slice(0,10);
          const val = Number(r.CumulativeSpend || 0);
          const prev = map.get(iso) || -Infinity;
          if(val >= prev) map.set(iso, val);
        }
        const entries = Array.from(map.entries()).sort((a,b)=> a[0].localeCompare(b[0]));
        const labels = entries.map(e => e[0]);
        const values = entries.map(e => e[1]);
        let runningMax = -Infinity;
        for(let i=0;i<values.length;i++){ if(values[i] < runningMax) values[i] = runningMax; else runningMax = values[i]; }
        return { labels, values, source: 'sheet' };
      }
    }

    function updateCumulativeChart(recs){
      const emptyEl = document.getElementById('chart-cumulative-empty');
      const { labels, values, source } = buildCumulativeSeries(recs);
      log('Cumulative source', source, 'points', labels.length);
      if(!labels || labels.length === 0) emptyEl.style.display = 'flex'; else emptyEl.style.display = 'none';

      createOrUpdateChart('chart-cumulative', {
        type: 'line',
        data: { labels, datasets: [{
          label: (source === 'sheet') ? 'Cumulative (sheet)' : 'Cumulative (calculated from Total Spend)',
          data: values,
          borderColor: getComputedStyle(document.documentElement).getPropertyValue('--hive-red') || '#e31337',
          backgroundColor: (ctx) => {
            const c = ctx.chart; const g = c.ctx.createLinearGradient(0,0,0,c.height || 420);
            g.addColorStop(0, 'rgba(227,19,55,0.16)'); g.addColorStop(0.6, 'rgba(227,19,55,0.06)'); g.addColorStop(1, 'rgba(227,19,55,0.02)');
            return g;
          },
          fill:true, tension:0.36, cubicInterpolationMode:'monotone',
          pointRadius:2, pointHoverRadius:6, pointBackgroundColor:'#fff', pointBorderColor:getComputedStyle(document.documentElement).getPropertyValue('--hive-red') || '#e31337',
          borderWidth:2.2, spanGaps:true
        }]},
        options: {
          plugins: { legend:{ position:'top' }, tooltip:{ callbacks:{ label: ctx => fmt(ctx.parsed.y) + ' HBD' } } },
          scales: { x:{ grid:{ display:false }, ticks:{ maxRotation:45, minRotation:25 } }, y:{ ticks:{ callback: v => fmt(v) } } },
          interaction:{ mode:'index', intersect:false }, animation:{ duration:500 }
        }
      });

      setTimeout(()=>{ try{ charts['chart-cumulative'] && charts['chart-cumulative'].resize && charts['chart-cumulative'].resize(); charts['chart-cumulative'] && charts['chart-cumulative'].update && charts['chart-cumulative'].update(); }catch(e){} }, 220);
    }

    function updateOtherCharts(recs){
      const catMap = new Map(); recs.forEach(r=>{ const k = r.Category || 'Unknown'; catMap.set(k, (catMap.get(k)||0) + Number(r.TotalSpend || 0)); });
      const catArr = Array.from(catMap.entries()).map(([k,v])=>({k,total:v})).sort((a,b)=>b.total-a.total);
      createOrUpdateChart('chart-category', {
        type:'doughnut',
        data:{ labels: catArr.map(a=>a.k), datasets:[{ data: catArr.map(a=>a.total), backgroundColor: generatePalette(catArr.length) }] },
        options:{
          plugins:{
            legend:{ position:'right',
              onClick: function(evt, item, legend) {
                const label = item.text || '';
                document.getElementById('filter-category').value = label || '';
                applyFiltersDebounced();
              }
            },
            tooltip:{ callbacks:{ label: ctx => fmt(ctx.parsed) + ' HBD' } }
          }
        }
      });

      // Event Type chart: ensure legend click filters by EventType (column H)
      const etMap = new Map(); recs.forEach(r=>{ const k = r.EventType || 'Unknown'; etMap.set(k, (etMap.get(k)||0) + Number(r.TotalSpend || 0)); });
      const etArr = Array.from(etMap.entries()).map(([k,v])=>({k,total:v})).sort((a,b)=>b.total-a.total);
      createOrUpdateChart('chart-eventtype', {
        type:'doughnut',
        data:{ labels: etArr.map(a=>a.k), datasets:[{ data: etArr.map(a=>a.total), backgroundColor: generatePalette(etArr.length) }] },
        options:{
          plugins:{
            legend:{ position:'right',
              onClick: function(evt, item, legend) {
                // Set hidden select 'filter-eventtype' so applyFilters uses it
                const label = item.text || '';
                document.getElementById('filter-eventtype').value = label || '';
                applyFiltersDebounced();
              }
            },
            tooltip:{ callbacks:{ label: ctx => fmt(ctx.parsed) + ' HBD' } }
          }
        }
      });

      // TOP PROJECTS
      const projMap = new Map(); recs.forEach(r=>{ const k=(r.EventProject||'Unknown')||'Unknown'; projMap.set(k, (projMap.get(k)||0) + Number(r.TotalSpend || 0)); });
      const projArr = Array.from(projMap.entries()).map(([k,v])=>({k,total:v})).sort((a,b)=>b.total-a.total).slice(0,10);
      createOrUpdateChart('chart-top-projects', {
        type:'bar',
        data:{ labels: projArr.map(a=>a.k), datasets:[{ label:'Total Spend', data: projArr.map(a=>a.total), backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--hive-red') || '#e31337' }]},
        options:{ indexAxis:'y', plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ callback: v => fmt(v) } } } }
      });

      // TOP WALLETS
      const wMap = new Map(); recs.forEach(r=>{ const k=(r.Wallet||'Unknown')||'Unknown'; wMap.set(k, (wMap.get(k)||0) + Number(r.TotalSpend || 0)); });
      const wArr = Array.from(wMap.entries()).map(([k,v])=>({k,total:v})).sort((a,b)=>b.total-a.total).slice(0,15);
      createOrUpdateChart('chart-top-wallets', {
        type:'bar',
        data:{ labels: wArr.map(a=>a.k), datasets:[{ label:'Total Spend', data: wArr.map(a=>a.total), backgroundColor: generatePalette(wArr.length) }]},
        options:{ indexAxis:'y', plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ callback: v => fmt(v) } } } }
      });

      setTimeout(()=>{ Object.keys(charts).forEach(k=>{ try{ charts[k] && charts[k].resize && charts[k].resize(); charts[k] && charts[k].update && charts[k].update(); }catch(e){} }); }, 300);
    }

    async function initMap(filteredRecords){
      try{
        if(!filteredRecords) filteredRecords = records.slice();
        if(map){ map.remove(); map = null; }
        map = L.map('mapchart', { zoomControl:true, attributionControl:false }).setView([20,0], 2);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { maxZoom:5 }).addTo(map);

        const agg = new Map();
        filteredRecords.forEach(r => {
          let nm = normalizeName(r.Country || '');
          if(!nm) return;
          if(COUNTRY_ALIAS[nm]) nm = COUNTRY_ALIAS[nm];
          agg.set(nm, (agg.get(nm) || 0) + Number(r.TotalSpend || 0));
        });
        currentCountryAgg = Object.fromEntries(agg.entries());

        const res = await fetch(GEOJSON_URL);
        if(!res.ok){ document.getElementById('map-info').style.display='block'; document.getElementById('map-info').textContent='Map data failed to load.'; return; }
        const geojson = await res.json();

        function styleFeature(feature){
          const raw = feature.properties.name || feature.properties.ADMIN || feature.properties.NAME || '';
          const nameNorm = normalizeName(raw);
          const val = currentCountryAgg[nameNorm] || 0;
          return { weight: 0.6, color: '#cfd8df', fillColor: getCountryColor(val), fillOpacity: val > 0 ? 0.88 : 0.12 };
        }

        function onEachFeature(feature, layer){
          const rawName = feature.properties.name || feature.properties.ADMIN || feature.properties.NAME || 'Unknown';
          const nameNorm = normalizeName(rawName);
          const val = currentCountryAgg[nameNorm] || 0;
          layer.bindPopup('<strong>' + escapeHtml(rawName) + '</strong><br/>Total spend: ' + fmt(val) + ' HBD');
          layer.on({
            mouseover: function(){ layer.setStyle({ weight: 1.4, color: '#333' }); document.getElementById('map-info').style.display='block'; document.getElementById('map-info').textContent = rawName + ' — ' + (val ? fmt(val) + ' HBD' : 'No data'); },
            mouseout: function(){ geoLayer.resetStyle(layer); document.getElementById('map-info').style.display='none'; },
            click: function(){ setCountryFilterByNormalized(nameNorm); applyFiltersDebounced(); }
          });
        }

        geoLayer = L.geoJSON(geojson, { style: styleFeature, onEachFeature: onEachFeature }).addTo(map);
        try{ map.fitBounds(geoLayer.getBounds(), { padding:[8,8] }); } catch(e){}
        try{ document.getElementById('mapchart').style.background = '#dff0ff'; }catch(e){}
      } catch(err){
        console.warn('initMap error', err);
        document.getElementById('map-info').style.display='block';
        document.getElementById('map-info').textContent = 'Map initialization error.';
      }
    }

    function setCountryFilterByNormalized(norm){
      const sel = document.getElementById('filter-country');
      for(const opt of Array.from(sel.options)){
        if(normalizeName(opt.value) === norm){ sel.value = opt.value; return; }
      }
      sel.value = '';
    }

    function getCountryColor(value){
      if(!value || value <= 0) return '#f0f2f4';
      const vals = Object.values(currentCountryAgg).map(v => Number(v) || 0);
      const max = Math.max(...vals, 1);
      const ratio = Math.log10((value || 0) + 1) / Math.log10(max + 1);
      const start = [235,245,250];
      const end = [227,19,55];
      const r = Math.round(start[0] + (end[0]-start[0])*ratio);
      const g = Math.round(start[1] + (end[1]-start[1])*ratio);
      const b = Math.round(start[2] + (end[2]-start[2])*ratio);
      return 'rgb(' + r + ',' + g + ',' + b + ')';
    }

    function getFilters(){
      return {
        from: document.getElementById('date-from').value,
        to: document.getElementById('date-to').value,
        country: document.getElementById('filter-country').value,
        category: document.getElementById('filter-category').value,
        theme: document.getElementById('filter-theme').value,
        eventtype: document.getElementById('filter-eventtype').value, // <-- NEW: hidden event type filter
        search: document.getElementById('search-wallet').value.trim().toLowerCase()
      };
    }

    function applyFilters(){
      const f = getFilters();
      let out = records.slice();
      if(f.from){
        const dFrom = new Date(f.from);
        out = out.filter(r => r.DateObj && r.DateObj >= dFrom);
      }
      if(f.to){
        const dTo = new Date(f.to); dTo.setHours(23,59,59,999);
        out = out.filter(r => r.DateObj && r.DateObj <= dTo);
      }
      if(f.country) out = out.filter(r => normalizeName(r.Country) === normalizeName(f.country));
      if(f.category) out = out.filter(r => (r.Category || '').toLowerCase() === f.category.toLowerCase());
      if(f.theme) out = out.filter(r => (r.Theme || '').toLowerCase() === f.theme.toLowerCase());
      if(f.eventtype) out = out.filter(r => (r.EventType || '').toLowerCase() === f.eventtype.toLowerCase()); // <-- NEW
      if(f.search) out = out.filter(r => (r.Wallet || '').toLowerCase().includes(f.search));

      renderTopMetrics(out);
      renderTable(out);
      updateCumulativeChart(out);
      updateOtherCharts(out);
      initMap(out);
    }

    let applyTimeout = null;
    function applyFiltersDebounced(){ if(applyTimeout) clearTimeout(applyTimeout); applyTimeout = setTimeout(()=>applyFilters(), 180); }

    function setChartInteractivity(){
      ['chart-category','chart-eventtype','chart-top-projects','chart-top-wallets'].forEach(id => {
        const el = document.getElementById(id); if(!el) return;
        el.addEventListener('click', (evt) => {
          const ch = charts[id]; if(!ch) return;
          const points = ch.getElementsAtEventForMode(evt, 'nearest', { intersect:true }, true);
          if(!points.length) return;
          const idx = points[0].index;
          const label = ch.data.labels[idx] || '';
          if(id === 'chart-category'){ document.getElementById('filter-category').value = label || ''; applyFiltersDebounced(); return; }
          if(id === 'chart-eventtype'){ document.getElementById('filter-eventtype').value = label || ''; applyFiltersDebounced(); return; }
          if(id === 'chart-top-projects'){
            const filtered = records.filter(r => (r.EventProject || '').toLowerCase() === (label || '').toLowerCase());
            renderTopMetrics(filtered); renderTable(filtered); updateCumulativeChart(filtered); updateOtherCharts(filtered); initMap(filtered);
            return;
          }
          if(id === 'chart-top-wallets'){ document.getElementById('search-wallet').value = label || ''; applyFiltersDebounced(); return; }
        });
      });
    }

    function setTheme(theme){
      document.documentElement.setAttribute('data-theme', theme);
      document.getElementById('switch-knob').style.transform = theme === 'light' ? 'translateX(20px)' : 'translateX(0)';
      localStorage.setItem('dashboard-theme', theme);
      Object.keys(charts || {}).forEach(k => { try{ charts[k] && charts[k].update && charts[k].update(); }catch(e){} });
    }

    async function init(){
      const saved = localStorage.getItem('dashboard-theme') || 'light'; setTheme(saved);
      const toggle = document.getElementById('theme-toggle');
      toggle.addEventListener('click', () => { const cur = document.documentElement.getAttribute('data-theme') || 'light'; setTheme(cur === 'light' ? 'dark' : 'light'); });
      toggle.addEventListener('keydown', (e) => { if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggle.click(); } });

      try{
        const { cols, rows } = await fetchSheet();
        records = processRows(cols, rows);
        populateFilters(records);
        renderTopMetrics(records);
        renderTable(records);
        updateCumulativeChart(records);
        updateOtherCharts(records);
        await initMap(records);
        setChartInteractivity();

        ['filter-country','filter-category','filter-theme','date-from','date-to'].forEach(id => {
          const el = document.getElementById(id); if(el) el.addEventListener('change', applyFiltersDebounced);
        });
        // include hidden eventtype select - if changed programmatically we call applyFilters
        const et = document.getElementById('filter-eventtype'); if(et) et.addEventListener('change', applyFiltersDebounced);

        const search = document.getElementById('search-wallet'); if(search) search.addEventListener('input', applyFiltersDebounced);
        const reset = document.getElementById('reset-filters'); if(reset) reset.addEventListener('click', () => { ['date-from','date-to','filter-country','filter-category','filter-theme','filter-eventtype','search-wallet'].forEach(id => document.getElementById(id).value = ''); applyFiltersDebounced(); });

        document.querySelectorAll('.card, .panel').forEach((el, idx) => setTimeout(()=> el.classList.add('revealed'), idx * 60));
        setTimeout(()=>{ try{ Object.keys(charts).forEach(k=>{ charts[k] && charts[k].resize && charts[k].resize(); charts[k] && charts[k].update && charts[k].update(); }); if(map) map.invalidateSize(); }catch(e){} }, 420);
      } catch(err){
        console.error('Initialization error', err);
        alert('Could not load data. Please verify the Google Sheet is public (Anyone with the link can view). Check console for details.');
      }
    }

    function waitForLibrariesAndInit(){
      const start = Date.now();
      (function poll(){
        if(window.Chart && window.L) { init(); return; }
        if(Date.now() - start > 7000) { console.warn('Libraries not loaded in time. Trying to init anyway.'); init(); return; }
        setTimeout(poll, 80);
      })();
    }

    document.addEventListener('DOMContentLoaded', waitForLibrariesAndInit);
  })();
  </script>
</body>
</html>
